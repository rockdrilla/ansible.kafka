version: '3'

x-pod-defaults: &pod_defaults
  network_mode: host
  restart: always
  hostname: "{{ ansible_fqdn }}"
  user: {{ app_uid }}:{{ app_gid }}

services:
  zookeeper:
    <<: *pod_defaults
    container_name: "{{ app_name }}-zk"
    image: "{{ image_registry }}/{{ image_zookeeper }}"
    environment:
      ZOO_SERVER_ID: "{{ zk_server_id }}"
      ZOO_SERVERS: "{{ zk_servers }}"
      ZOO_PORT_NUMBER: "{{ zk_client_port }}"
    # ZOO_TLS_PORT_NUMBER: "{{ zk_tls_port }}"
      ALLOW_ANONYMOUS_LOGIN: yes
    volumes:
      - {{ app_workdir }}/data/zookeeper:/bitnami/zookeeper
      - {{ app_workdir }}/conf/zookeeper:/opt/bitnami/zookeeper/conf
  zookeeper-exporter:
    <<: *pod_defaults
    container_name: "{{ app_name }}-zk-exporter"
    image: "{{ image_registry }}/{{ image_zookeeper_exporter }}"
    depends_on:
      - zookeeper
    command:
      - "--listen=0.0.0.0:{{ zk_exporter_port }}"
      - "--zk-hosts={{ zk_hosts }}"
# zookeeper-jmx-exporter:
#   <<: *pod_defaults
#   container_name: "{{ app_name }}-zk-jmx-exporter"
#   image: "{{ image_registry }}/{{ image_jmx_exporter }}"
#   depends_on:
#     - zookeeper
#   command:
#     - "{{ zk_jmx_exporter_port }}"
#     - "/app/zk.yml"
#   volumes:
#     - {{ app_workdir }}/conf/zk-jmx-config.yml:/app/zk.yml
